<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Summary</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="homepage" class="container">
        <h1>Welcome to Shift Summary</h1>
        <button id="newDayBtn">Start New Shift Summary</button>
        <div id="daysList"></div>
    </div>

    <div id="notepad" class="container" style="display: none;">
        <h1>Shift Summary - <span id="currentDate"></span></h1>
        <textarea id="noteInput" placeholder="Type your note here..."></textarea>
        <button id="addNoteBtn">Add Note</button>
        <button id="endShiftBtn">End Shift</button>
        <button id="backBtn">Back to Homepage</button>
        <div id="notesContainer"></div>
    </div>

    <!-- Include docxtemplater and its dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.45.0/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip-utils.js"></script>
    <!--
    Mandatory in IE 6, 7, 8 and 9.
    -->
    <!--[if IE]>
        <script
            type="text/javascript"
            src="https://unpkg.com/pizzip@3.1.6/dist/pizzip-utils-ie.js"
        ></script>
    <![endif]-->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const homepage = document.getElementById('homepage');
            const notepad = document.getElementById('notepad');
            const currentDateElement = document.getElementById('currentDate');
            const noteInput = document.getElementById('noteInput');
            const notesContainer = document.getElementById('notesContainer');
            const daysList = document.getElementById('daysList');
            const addNoteBtn = document.getElementById('addNoteBtn');
            const endShiftBtn = document.getElementById('endShiftBtn');
            const backBtn = document.getElementById('backBtn');
            const newDayBtn = document.getElementById('newDayBtn');

            let currentDayKey = null;

            function loadDays() {
                daysList.innerHTML = '';
                const days = Object.keys(localStorage).sort();
                days.forEach(day => {
                    const dayContainer = document.createElement('div');
                    dayContainer.classList.add('dayContainer');

                    const dayButton = document.createElement('button');
                    dayButton.innerText = day;
                    dayButton.addEventListener('click', () => {
                        openDay(day);
                    });

                    const deleteDayBtn = document.createElement('button');
                    deleteDayBtn.classList.add('deleteDayBtn');
                    deleteDayBtn.innerHTML = 'x';
                    deleteDayBtn.addEventListener('click', () => {
                        deleteDay(day);
                    });

                    dayContainer.appendChild(dayButton);
                    dayContainer.appendChild(deleteDayBtn);

                    daysList.appendChild(dayContainer);
                });
            }

            function openDay(day) {
                currentDayKey = day;
                currentDateElement.innerText = day;
                homepage.style.display = 'none';
                notepad.style.display = 'block';
                notesContainer.innerHTML = '';
                const notes = JSON.parse(localStorage.getItem(day)) || [];
                notes.forEach(note => {
                    const noteElement = createNoteElement(note);
                    notesContainer.appendChild(noteElement);
                });
            }

            function createNoteElement(note) {
    const timestamp = new Date(note.timestamp);
    const time = timestamp.toLocaleTimeString(); // Get only the time part

    const noteElement = document.createElement('div');
    noteElement.classList.add('note');
    noteElement.dataset.timestamp = timestamp.getTime(); // Store timestamp as data attribute
    noteElement.innerHTML = `<strong>${time}</strong> ${note.text}`; // Removed colon after time
    
    const deleteNoteBtn = document.createElement('button');
    deleteNoteBtn.classList.add('deleteNoteBtn');
    deleteNoteBtn.innerHTML = 'x';
    deleteNoteBtn.addEventListener('click', (event) => {
        deleteNote(event);
    });

    noteElement.appendChild(deleteNoteBtn);
    
    return noteElement;
}
            function addNote() {
                const noteText = noteInput.value;
                if (noteText) {
                    const timestamp = new Date().toLocaleString();
                    const note = { timestamp, text: noteText };
                    const noteElement = createNoteElement(note);
                    notesContainer.appendChild(noteElement);
                    noteInput.value = '';

                    const notes = JSON.parse(localStorage.getItem(currentDayKey)) || [];
                    notes.push(note);
                    localStorage.setItem(currentDayKey, JSON.stringify(notes));
                }
            }

            function deleteNote() {
                const noteToDelete = event.target.parentElement;
                noteToDelete.remove();

                const notes = JSON.parse(localStorage.getItem(currentDayKey)) || [];
                const updatedNotes = notes.filter(note => note.timestamp !== noteToDelete.querySelector('strong').innerText);
                localStorage.setItem(currentDayKey, JSON.stringify(updatedNotes));
            }

            function deleteDay(day) {
                localStorage.removeItem(day);
                loadDays();
            }

            function endDay() {
    console.log('End Shift button clicked');
    const noteElements = document.querySelectorAll('.note');
    const allNotes = [];
    noteElements.forEach(noteElement => {
        const timestamp = new Date(parseInt(noteElement.dataset.timestamp)).toLocaleTimeString(); // Retrieve timestamp from data attribute
        const text = noteElement.querySelector('strong').nextSibling.textContent.trim(); // Get text after strong element
        allNotes.push(`${timestamp} - ${text}`); // Adjusted to have one hyphen
    });

    const currentDate = document.getElementById('currentDate').textContent;

    if (allNotes.length > 0) {
        console.log('Notes found, attempting conversion to Word document...');
        generate(allNotes, currentDate);
    } else {
        console.error('No notes to export');
    }
}





            function startNewDay() {
                const today = new Date().toLocaleDateString();
                if (!localStorage.getItem(today)) {
                    localStorage.setItem(today, JSON.stringify([{ timestamp: new Date().toLocaleString(), text: 'Start of day' }]));
                }
                openDay(today);
            }

            addNoteBtn.addEventListener('click', addNote);
            noteInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
event.preventDefault(); // Prevents default behavior of adding a new line
addNote();
}
});

endShiftBtn.addEventListener('click', endDay);
        backBtn.addEventListener('click', () => {
            homepage.style.display = 'block';
            notepad.style.display = 'none';
            loadDays();
        });
        newDayBtn.addEventListener('click', startNewDay);

        loadDays();
    });

    // Function to generate the document with the given notes and current date
// Update the generate function to accept notes and date parameters
function generate(notes, date) {
    loadFile(
        "Shift_Summary_Template.docx",
        function (content) {
            try {
                console.log("Template loaded successfully.");

                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                console.log("Document initialized successfully.");

                // Parse the date string to ensure consistency across devices
                const formattedDate = new Date(date);
                const isoDateString = formattedDate.toISOString(); // Format date as ISO 8601

                // Render the document with the provided notes and formatted date
                doc.render({
                    shiftDate: "Shift Summary - " + isoDateString, // Use ISO 8601 formatted date
                    notes: notes.join("\n\n")
                });

                console.log("Document rendered successfully.");

                // Generate the document blob
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    compression: "DEFLATE",
                });

                console.log("Document blob generated successfully.");

                // Save the document with the formatted date in the file name
                const formattedFileName = formattedDate.toLocaleDateString('en-US').replace(/[/\\?%*:|"<>]/g, '-'); // Format date for file name
                const fileName = `Shift Summary ${formattedFileName}.docx`;

                // Create a temporary anchor element for downloading
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(blob);
                downloadLink.download = fileName;

                // Trigger download
                downloadLink.click();

                console.log("Download triggered successfully.");
            } catch (error) {
                console.error('Error during document generation:', error);
            }
        }
    );
}



    // Function to load the file from the given URL
    function loadFile(url, callback) {
        fetch(url) // Fetch the file from the URL
            .then(response => response.blob()) // Convert the response to a blob
            .then(blob => {
                var reader = new FileReader(); // Create a FileReader object
                reader.onload = function(event) {
                    var arrayBuffer = event.target.result; // Get the result as an ArrayBuffer
                    callback(arrayBuffer); // Call the callback function with the ArrayBuffer
                };
                reader.readAsArrayBuffer(blob); // Read the blob as an ArrayBuffer
            })
            .catch(error => console.error('Error loading file:', error)); // Log any errors during the fetch
    }
</script>
</body>
</html>

